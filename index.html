<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>RentMaster Keyboard Fix</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --primary: #3b82f6; --bg: #f3f4f6; --surface: #ffffff;
            --dark-card: #1e1e1e; --text-on-dark: #f3f4f6; --text: #0f172a; 
            --danger: #ef4444; --success: #22c55e; --warning: #facc15;
            --repair-bg: #fef08a; --repair-border: #eab308;
            --deleted-text: #94a3b8;
        }
        /* –°—Ç–∏–ª—å –¥–ª—è —ç–∫—Ä–∞–Ω–∞ –≤—Ö–æ–¥–∞ */
        #auth-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100dvh;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            box-sizing: border-box;
        }
        .auth-card {
            background: var(--surface);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .auth-logo {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 20px;
        }
        .auth-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--text);
            margin-bottom: 10px;
        }
        .auth-subtitle {
            color: #64748b;
            margin-bottom: 30px;
            font-size: 0.9rem;
        }
        .auth-input {
            width: 100%;
            padding: 14px;
            margin-bottom: 15px;
            border: 1px solid #cbd5e1;
            border-radius: 10px;
            font-size: 16px;
            box-sizing: border-box;
            transition: 0.2s;
        }
        .auth-input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .auth-btn {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.2s;
            margin-bottom: 10px;
        }
        .auth-btn:hover {
            opacity: 0.9;
        }
        .auth-btn.secondary {
            background: #e2e8f0;
            color: #475569;
        }
        .auth-btn.danger {
            background: var(--danger);
        }
        .auth-switch {
            margin-top: 20px;
            color: #64748b;
            font-size: 0.9rem;
        }
        .auth-switch a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }
        .auth-error {
            background: #fee2e2;
            color: #b91c1c;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            display: none;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
            padding: 5px 10px;
            background: #e2e8f0;
            border-radius: 20px;
            font-size: 0.8rem;
        }
        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .sync-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .sync-status.syncing {
            background: #f59e0b;
        }
        .sync-status.error {
            background: #ef4444;
        }
        .sync-status.success {
            background: #22c55e;
        }
        /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
        body { 
            font-family: 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg); color: var(--text); 
            margin: 0; height: 100dvh; 
            display: flex; flex-direction: column; 
            overflow: hidden; user-select: none; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        /* HEADER */
        header { 
            background: var(--surface); 
            padding: 10px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
            display: flex; 
            gap: 8px; 
            overflow-x: auto; 
            flex-shrink: 0; 
            z-index: 20; 
        }
        .nav-btn { 
            background: #e2e8f0; 
            border: none; 
            padding: 10px 16px; 
            border-radius: 8px; 
            color: #475569; 
            font-weight: 700; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            white-space: nowrap; 
            transition: 0.2s; 
            font-size: 0.9rem; 
        }
        .nav-btn.active { 
            background: var(--primary); 
            color: white; 
            box-shadow: 0 4px 6px -1px rgba(59,130,246,0.4); 
        }
        .badge { 
            background: #ef4444; 
            color: white; 
            border-radius: 12px; 
            padding: 2px 6px; 
            font-size: 0.75rem; 
            margin-left: 4px; 
        }

        /* MAIN */
        main { 
            flex: 1; 
            padding: 10px; 
            padding-bottom: 300px; 
            overflow-y: auto; 
            max-width: 1000px; 
            margin: 0 auto; 
            width: 100%; 
            box-sizing: border-box; 
            scroll-behavior: smooth; 
        }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from {opacity:0; transform:translateY(4px);} to {opacity:1; transform:translateY(0);} }

        /* ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */
        
    </style>
</head>
<body>

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ -->
<div id="auth-container">
    <div class="auth-card" id="login-form">
        <div class="auth-logo"><i class="fas fa-bolt"></i></div>
        <div class="auth-title">RentMaster</div>
        <div class="auth-subtitle">–í–æ–π–¥–∏—Ç–µ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö</div>
        
        <div class="auth-error" id="auth-error"></div>
        
        <input type="email" id="login-email" class="auth-input" placeholder="Email" autocomplete="email">
        <input type="password" id="login-password" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å">
        
        <button class="auth-btn" onclick="login()">–í–æ–π—Ç–∏</button>
        <button class="auth-btn secondary" onclick="googleLogin()">
            <i class="fab fa-google"></i> –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
        </button>
        
        <div class="auth-switch">
            –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a onclick="showRegister()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
        </div>
    </div>
    
    <div class="auth-card" id="register-form" style="display:none;">
        <div class="auth-logo"><i class="fas fa-bolt"></i></div>
        <div class="auth-title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
        <div class="auth-subtitle">–°–æ–∑–¥–∞–π—Ç–µ –∞–∫–∫–∞—É–Ω—Ç –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</div>
        
        <div class="auth-error" id="reg-error"></div>
        
        <input type="text" id="reg-name" class="auth-input" placeholder="–ò–º—è" autocomplete="name">
        <input type="email" id="reg-email" class="auth-input" placeholder="Email" autocomplete="email">
        <input type="password" id="reg-password" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)">
        <input type="password" id="reg-password-confirm" class="auth-input" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
        
        <button class="auth-btn" onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        
        <div class="auth-switch">
            –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a onclick="showLogin()">–í–æ–π—Ç–∏</a>
        </div>
    </div>
</div>

<!-- –°—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ -->
<div id="sync-status" class="sync-status">
    <i class="fas fa-cloud"></i> <span id="sync-text">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...</span>
</div>

<!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (—Å–∫—Ä—ã—Ç–æ –¥–æ –≤—Ö–æ–¥–∞) -->
<div id="app-container" style="display:none;">
    <div id="toast-container"></div>

    <header>
        <button class="nav-btn active" onclick="switchView('active')"><i class="fas fa-bolt"></i> –ê–∫—Ç–∏–≤–Ω—ã–µ <span id="badge-cnt" class="badge" style="display:none">0</span></button>
        <button class="nav-btn" onclick="switchView('new')"><i class="fas fa-plus"></i> –ù–æ–≤–∞—è</button>
        <button class="nav-btn" onclick="switchView('fleet')"><i class="fas fa-bicycle"></i> –ü–∞—Ä–∫</button>
        <button class="nav-btn" onclick="switchView('clients')"><i class="fas fa-users"></i> –ö–ª–∏–µ–Ω—Ç—ã</button>
        <button class="nav-btn" onclick="switchView('surcharge')"><i class="fas fa-hand-holding-usd"></i> –î–æ–ø–ª–∞—Ç–∞</button>
        <button class="nav-btn" onclick="switchView('finance')"><i class="fas fa-chart-line"></i> –ò—Å—Ç–æ—Ä–∏—è</button>
        <button class="nav-btn" onclick="switchView('settings')"><i class="fas fa-cog"></i></button>
        <div class="user-info">
            <div class="user-avatar" id="user-avatar">U</div>
            <span id="user-name">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
            <button onclick="logout()" style="background:none; border:none; color:#64748b; cursor:pointer;">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
    </header>

    <main>
        <!-- –í—Å–µ view –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
        <div id="view-new" class="view">
            <div class="card">
                <h2>üìù –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</h2>
                <div class="input-row">
                    <div class="input-wrapper">
                        <input type="tel" id="rent-phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" oninput="handleInput('phone', this.value)" autocomplete="off">
                        <div id="suggest-phone" class="suggestions-box"></div>
                    </div>
                    <div class="input-wrapper">
                        <input type="text" id="rent-name" placeholder="–ò–º—è" oninput="handleInput('name', this.value)" autocomplete="off">
                        <div id="suggest-name" class="suggestions-box"></div>
                    </div>
                </div>
                <div id="blacklist-alert" style="display:none; background:#fee2e2; color:#b91c1c; padding:10px; border-radius:8px; margin-bottom:10px; font-weight:bold; text-align: center;">‚ö†Ô∏è –ö–õ–ò–ï–ù–¢ –í –ß–ï–†–ù–û–ú –°–ü–ò–°–ö–ï</div>
                <p style="margin:15px 0 5px 0; font-size:0.85rem; color:#64748b; font-weight:700;">–í–´–ë–ï–†–ò–¢–ï –¢–†–ê–ù–°–ü–û–†–¢:</p>
                <input type="text" id="new-fleet-search" class="new-rent-search" placeholder="üîç –ü–æ–∏—Å–∫ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞..." oninput="renderNewRent()">
                <div id="fleet-selector"></div>
                <div id="tariff-block" style="display:none; margin-top:20px;">
                    <p style="margin:5px 0; font-size:0.85rem; color:#64748b; font-weight:700;">–í–´–ë–û–† –¢–ê–†–ò–§–ê:</p>
                    <div id="tariff-buttons" class="tariff-grid"></div>
                </div>
            </div>
        </div>

        <div id="view-active" class="view active">
            <div style="margin-bottom:10px;">
                <input type="text" id="active-search" placeholder="üîç –ü–æ–∏—Å–∫..." oninput="renderActiveRentals()">
            </div>
            <div id="active-list"></div>
            <div id="no-active-msg" style="text-align:center; color:#94a3b8; margin-top:50px;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–µ–∑–¥–æ–∫</div>
        </div>

        <div id="view-fleet" class="view">
            <div class="card">
                <h2>–ü–∞—Ä–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤</h2>
                <select id="new-fleet-cat"></select>
                <div style="display:flex; gap:8px;">
                    <input type="text" id="new-fleet-name" placeholder="–ù–æ–º–µ—Ä/–ò–º—è">
                    <input type="color" id="new-fleet-color" value="#3b82f6" style="width:50px; padding:2px; height:46px;">
                </div>
                <button class="btn btn-primary" onclick="addVehicle()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
            <div id="fleet-list"></div>
        </div>

        <div id="view-clients" class="view">
            <div class="card">
                <h2>–ë–∞–∑–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤</h2>
                <input type="text" id="client-search" placeholder="–ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞..." oninput="renderClients()">
                <div id="clients-list" style="margin-top:10px;"></div>
            </div>
        </div>

        <div id="view-surcharge" class="view">
            <div class="profit-card" style="background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                <div style="opacity:0.9; font-size:0.9rem;">–°–£–ú–ú–ê –î–û–ü–õ–ê–¢ (–ü–û –§–ò–õ–¨–¢–†–£)</div>
                <div style="font-size:2.5rem; font-weight:800;" id="sur-total">0 ‚ÇΩ</div>
            </div>
            <div class="card">
                <h2>–§–∏–ª—å—Ç—Ä—ã –¥–æ–ø–ª–∞—Ç</h2>
                <div class="filter-row">
                    <input type="date" id="sur-start" onchange="renderSurcharge()">
                    <input type="date" id="sur-end" onchange="renderSurcharge()">
                </div>
                <input type="text" id="sur-search" placeholder="üîç –ü–æ–∏—Å–∫ (–ò–º—è, –¢–µ–ª, –£—Å—Ç—Ä.)" oninput="renderSurcharge()">
            </div>
            <div class="card" style="padding:0; overflow:hidden;">
                <div style="overflow-x:auto;">
                    <table class="history-table">
                        <thead><tr><th>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</th><th>–ö–ª–∏–µ–Ω—Ç</th><th>–í—Ä–µ–º—è</th><th>–°–≤–µ—Ä—Ö</th><th>–ö –æ–ø–ª–∞—Ç–µ</th></tr></thead>
                        <tbody id="surcharge-rows"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-finance" class="view">
            <div class="profit-card">
                <div style="opacity:0.9; font-size:0.9rem;">–ü–†–ò–ë–´–õ–¨ –ü–û –í–´–ë–û–†–ö–ï</div>
                <div style="font-size:2.5rem; font-weight:800;" id="history-total">0 ‚ÇΩ</div>
            </div>
            <div class="card">
                <h2>–§–∏–ª—å—Ç—Ä—ã</h2>
                <div class="filter-row">
                    <input type="date" id="hist-start" onchange="renderHistory()">
                    <input type="date" id="hist-end" onchange="renderHistory()">
                    <select id="hist-pay" onchange="renderHistory()">
                        <option value="all">üí≥ –í—Å–µ –æ–ø–ª–∞—Ç—ã</option>
                        <option value="cash">üíµ –ù–∞–ª–∏—á–Ω—ã–µ</option>
                        <option value="bank">üè¶ –ë–∞–Ω–∫/–ö–∞—Ä—Ç–∞</option>
                    </select>
                </div>
                <div class="filter-row">
                    <input type="text" id="hist-search" placeholder="üîç –ò–º—è, –¢–µ–ª, –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ" oninput="renderHistory()">
                    <div class="device-filter-container">
                        <button class="btn btn-sm device-filter-btn" onclick="toggleDevDropdown()">üì± –í—ã–±–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤ <i class="fas fa-chevron-down"></i></button>
                        <div id="dev-dd" class="device-dropdown">
                            <input type="text" class="dd-search-input" placeholder="–ü–æ–∏—Å–∫..." oninput="filterDevDropdown(this.value)">
                            <div id="dev-dd-list"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card" style="padding:0; overflow:hidden;">
                <div style="overflow-x:auto;">
                    <table class="history-table">
                        <thead><tr><th>–£—Å—Ç—Ä.</th><th>–ö–ª–∏–µ–Ω—Ç</th><th>–°—Ç–∞—Ä—Ç/–ö–æ–Ω–µ—Ü</th><th>–ü–∞—É–∑–∞</th><th>–°–≤–µ—Ä—Ö</th><th>–û–ø–ª–∞—Ç–∞</th><th>–°—É–º–º–∞</th><th></th></tr></thead>
                        <tbody id="history-rows"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-settings" class="view">
            <div class="card">
                <h2>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h2>
                <button class="btn btn-primary" onclick="openCatModal()">+ –°–æ–∑–¥–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</button>
                <div id="settings-list" style="margin-top:15px;"></div>
            </div>
            <div class="card">
                <button class="btn btn-success" onclick="requestWakeLock()" style="margin-bottom:10px; width:100%;">üí° –í–∫–ª—é—á–∏—Ç—å "–ù–µ —Å–ø–∞—Ç—å" (WakeLock)</button>
                <button class="btn btn-secondary" onclick="testAudio()" style="margin-bottom:10px; width:100%;">üîä –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∞—É–¥–∏–æ</button>
                <div id="wakelock-status">–≠–∫—Ä–∞–Ω –º–æ–∂–µ—Ç –ø–æ–≥–∞—Å–Ω—É—Ç—å (–Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É)</div>
            </div>
            <div class="card"><button class="btn btn-danger" onclick="fullReset()">‚ö† –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö</button></div>
        </div>
    </main>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
    <div id="modal-confirm" class="modal-overlay" style="z-index: 200;">
        <div class="modal-content" style="text-align:center;">
            <i class="fas fa-question-circle" style="font-size:3rem; color:var(--primary); margin-bottom:15px;"></i>
            <h3 id="confirm-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3>
            <p id="confirm-text" style="color:#64748b; margin-bottom:20px;">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</p>
            <div class="confirm-actions">
                <button class="btn btn-danger" id="btn-confirm-no">–ù–ï–¢</button>
                <button class="btn btn-success" id="btn-confirm-yes">–î–ê</button>
            </div>
        </div>
    </div>

    <div id="modal-start-confirm" class="modal-overlay">
        <div class="modal-content">
            <h3>üí∞ –§–æ—Ä–º–∞ –æ–ø–ª–∞—Ç—ã</h3>
            <div style="background:#f8fafc; padding:15px; border-radius:10px; margin:15px 0; text-align:center; border:1px solid #eee;">
                <div id="confirm-tariff-name" style="font-weight:bold; font-size:1.2rem; color:var(--primary);"></div>
                <div id="confirm-devices" style="margin-top:5px; color:#64748b;"></div>
                <div id="confirm-cost" style="margin-top:10px; font-weight:bold; font-size:1.5rem;"></div>
            </div>
            <p style="text-align:center; color:#64748b; margin-bottom:10px;">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:</p>
            <div style="display:flex; gap:15px; margin-bottom:15px;">
                <div class="pay-choice-btn pay-choice-cash" onclick="confirmPaymentChoice('cash')">
                    <i class="fas fa-money-bill-wave" style="font-size:2rem;"></i> –ù–∞–ª–∏—á–Ω—ã–µ
                </div>
                <div class="pay-choice-btn pay-choice-bank" onclick="confirmPaymentChoice('bank')">
                    <i class="fas fa-credit-card" style="font-size:2rem;"></i> –ë–∞–Ω–∫/–ö–∞—Ä—Ç–∞
                </div>
            </div>
            <button class="btn btn-secondary" onclick="closeModal('modal-start-confirm')">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <div id="modal-final-start" class="modal-overlay" style="z-index: 150;">
        <div class="modal-content" style="text-align:center">
            <h3>üöÄ –ù–∞—á–∞—Ç—å –ø–æ–µ–∑–¥–∫—É?</h3>
            <div style="margin:20px 0; color:#64748b;">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Å—Ç–∞—Ä—Ç.</div>
            <div class="confirm-actions">
                <button class="btn btn-danger" onclick="closeModal('modal-final-start')">–ù–µ—Ç</button>
                <button class="btn btn-success" onclick="realStartRental()">–î–∞, –ø–æ–µ—Ö–∞–ª–∏</button>
            </div>
        </div>
    </div>

    <div id="modal-sub" class="modal-overlay">
        <div class="modal-content">
            <h3 id="sub-title">–í—ã–±–æ—Ä</h3>
            <input type="text" id="swap-search" class="swap-search" placeholder="–ü–æ–∏—Å–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞..." oninput="renderSwapList(this.value)">
            <div id="swap-list-container" class="swap-list-container"></div>
            <button class="btn btn-primary" id="btn-do-swap" onclick="finalizeSwap()" disabled>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–±–æ—Ä</button>
            <button class="btn btn-secondary" onclick="closeModal('modal-sub')" style="margin-top:10px;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div id="modal-client" class="modal-overlay">
        <div class="modal-content">
            <h3>–ö–ª–∏–µ–Ω—Ç</h3>
            <input type="hidden" id="edit-cl-id">
            <input type="text" id="edit-cl-name" placeholder="–ò–º—è">
            <input type="tel" id="edit-cl-phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
            <textarea id="edit-cl-comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" rows="3"></textarea>
            <label style="display:flex; align-items:center; gap:10px; margin:10px 0;"><input type="checkbox" id="edit-cl-block" style="width:auto; margin:0;"><span style="color:var(--danger); font-weight:bold;">–ß–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫</span></label>
            <div style="display:flex; gap:10px; margin-top:20px;"><button class="btn btn-danger" onclick="delClient()">–£–¥–∞–ª–∏—Ç—å</button><button class="btn btn-primary" onclick="saveClient()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
            <button class="btn btn-secondary" onclick="closeModal('modal-client')" style="margin-top:10px;">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <div id="modal-vehicle-note" class="modal-overlay">
        <div class="modal-content">
            <h3>‚öôÔ∏è –ó–∞–º–µ—Ç–∫–∞ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É</h3>
            <input type="hidden" id="note-v-id">
            <div id="note-v-name" style="margin-bottom:10px; font-weight:bold;"></div>
            <textarea id="note-v-text" placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É –∏–ª–∏ —Å—Ç–∞—Ç—É—Å..." rows="5"></textarea>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-danger" onclick="deleteVehicleNote()">–£–¥–∞–ª–∏—Ç—å –∑–∞–º–µ—Ç–∫—É</button>
                <button class="btn btn-primary" onclick="saveVehicleNote()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
            <button class="btn btn-secondary" onclick="closeModal('modal-vehicle-note')" style="margin-top:10px;">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <div id="modal-cat" class="modal-overlay">
        <div class="modal-content">
            <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</h3>
            <input type="hidden" id="edit-cat-id">
            <input type="text" id="edit-cat-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
            <input type="number" id="edit-cat-rate" placeholder="–¶–µ–Ω–∞ –º–∏–Ω—É—Ç—ã (—Å–≤–µ—Ä—Ö —Ç–∞—Ä–∏—Ñ–∞) ‚ÇΩ">
            <div style="margin-top:15px; padding-top:10px; border-top:1px solid #eee;">
                <h4>–¢–∞—Ä–∏—Ñ—ã</h4><div id="cat-tariffs-list"></div>
                <div style="background:#f1f5f9; padding:10px; border-radius:10px; margin-top:10px;"><select id="nt-type"><option value="fix">–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π</option><option value="std">–ü–æ–º–∏–Ω—É—Ç–Ω—ã–π</option></select><input type="text" id="nt-name" placeholder="–ò–º—è (–Ω–∞–ø—Ä. 30 –º–∏–Ω)"><div style="display:flex; gap:5px;"><input type="number" id="nt-v1" placeholder="–ú–∏–Ω / –°—Ç–∞—Ä—Ç"><input type="number" id="nt-v2" placeholder="–¶–µ–Ω–∞ / –ú–∏–Ω"></div><button class="btn btn-success btn-sm" onclick="addTariffIO()">+ –¢–∞—Ä–∏—Ñ</button></div>
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;"><button class="btn btn-secondary" onclick="closeModal('modal-cat')">–û—Ç–º–µ–Ω–∞</button><button class="btn btn-primary" onclick="saveCat()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
        </div>
    </div>
</div>

<script>
    // ===== FIREBASE CONFIG =====
    const firebaseConfig = {
        apiKey: "AIzaSyCOh3RXnyOpa81Tpla8F44rTFteP4zoc3U",
        authDomain: "skuter75rus-3d55d.firebaseapp.com",
        projectId: "skuter75rus-3d55d",
        storageBucket: "skuter75rus-3d55d.firebasestorage.app",
        messagingSenderId: "1054204994225",
        appId: "1:1054204994225:web:692c298038a0d3bbc2f890",
        measurementId: "G-J47C67V554"
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
    let firebaseApp, firebaseAuth, firebaseFirestore;
    let currentUser = null;
    let unsubscribeFunctions = [];
    let isSyncing = false;
    let lastSyncTime = null;
    
    function initFirebase() {
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            firebaseAuth = firebase.auth();
            firebaseFirestore = firebase.firestore();
            
            // –°–ª–µ–¥–∏–º –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            firebaseAuth.onAuthStateChanged(handleAuthStateChanged);
            
            console.log("Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:", error);
            showAuthError("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É");
        }
    }
    
    // ===== –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø =====
    function showLogin() {
        document.getElementById('login-form').style.display = 'block';
        document.getElementById('register-form').style.display = 'none';
        clearAuthErrors();
    }
    
    function showRegister() {
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('register-form').style.display = 'block';
        clearAuthErrors();
    }
    
    function clearAuthErrors() {
        document.getElementById('auth-error').style.display = 'none';
        document.getElementById('reg-error').style.display = 'none';
    }
    
    function showAuthError(message, isReg = false) {
        const errorEl = isReg ? document.getElementById('reg-error') : document.getElementById('auth-error');
        errorEl.innerText = message;
        errorEl.style.display = 'block';
    }
    
    async function login() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        
        if (!email || !password) {
            showAuthError("–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å");
            return;
        }
        
        try {
            updateSyncStatus("–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É...", "syncing");
            await firebaseAuth.signInWithEmailAndPassword(email, password);
            // handleAuthStateChanged –≤—ã–∑–æ–≤–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:", error);
            showAuthError(getAuthErrorMessage(error.code));
            updateSyncStatus("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞", "error");
        }
    }
    
    async function register() {
        const name = document.getElementById('reg-name').value;
        const email = document.getElementById('reg-email').value;
        const password = document.getElementById('reg-password').value;
        const passwordConfirm = document.getElementById('reg-password-confirm').value;
        
        if (!name || !email || !password) {
            showAuthError("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è", true);
            return;
        }
        
        if (password.length < 6) {
            showAuthError("–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤", true);
            return;
        }
        
        if (password !== passwordConfirm) {
            showAuthError("–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç", true);
            return;
        }
        
        try {
            updateSyncStatus("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...", "syncing");
            const userCredential = await firebaseAuth.createUserWithEmailAndPassword(email, password);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            await userCredential.user.updateProfile({
                displayName: name
            });
            
            // –°–æ–∑–¥–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            await initializeUserData(userCredential.user.uid);
            
            updateSyncStatus("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞", "success");
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:", error);
            showAuthError(getAuthErrorMessage(error.code), true);
            updateSyncStatus("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏", "error");
        }
    }
    
    async function googleLogin() {
        try {
            const provider = new firebase.auth.GoogleAuthProvider();
            await firebaseAuth.signInWithPopup(provider);
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ Google –≤—Ö–æ–¥–∞:", error);
            showAuthError("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Google");
        }
    }
    
    async function logout() {
        try {
            // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç –≤—Å–µ—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π
            unsubscribeAll();
            
            await firebaseAuth.signOut();
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('auth-container').style.display = 'flex';
            showLogin();
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            db = getDefaultDb();
            saveToLocal();
            
            updateSyncStatus("–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã", "success");
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:", error);
        }
    }
    
    function getAuthErrorMessage(code) {
        const messages = {
            'auth/invalid-email': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email',
            'auth/user-disabled': '–ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω',
            'auth/user-not-found': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω',
            'auth/wrong-password': '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å',
            'auth/email-already-in-use': 'Email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è',
            'auth/weak-password': '–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º –ø—Ä–æ—Å—Ç–æ–π',
            'auth/network-request-failed': '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'
        };
        return messages[code] || '–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏';
    }
    
    // ===== –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –î–ê–ù–ù–´–• =====
    async function handleAuthStateChanged(user) {
        if (user) {
            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª
            currentUser = user;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            document.getElementById('user-name').textContent = user.displayName || user.email;
            document.getElementById('user-avatar').textContent = user.displayName ? user.displayName.charAt(0).toUpperCase() : user.email.charAt(0).toUpperCase();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
            await loadAndSyncData();
            
            updateSyncStatus("–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ", "success");
        } else {
            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª
            currentUser = null;
        }
    }
    
    async function initializeUserData(uid) {
        const defaultData = getDefaultDb();
        await firebaseFirestore.collection('users').doc(uid).set({
            data: defaultData,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    }
    
    async function loadAndSyncData() {
        if (!currentUser) return;
        
        try {
            updateSyncStatus("–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...", "syncing");
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Firestore
            const userDoc = await firebaseFirestore.collection('users').doc(currentUser.uid).get();
            
            if (userDoc.exists) {
                const cloudData = userDoc.data().data;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                const localData = loadFromLocal();
                
                // –°–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —É –±–æ–ª–µ–µ –Ω–æ–≤—ã—Ö)
                db = mergeData(cloudData, localData);
            } else {
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —Å –Ω–∞—á–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                await initializeUserData(currentUser.uid);
                db = getDefaultDb();
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
            saveToLocal();
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
            setupRealtimeListener();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            updateUI();
            
            updateSyncStatus("–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã", "success");
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:", error);
            updateSyncStatus("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏", "error");
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ fallback
            db = loadFromLocal() || getDefaultDb();
            updateUI();
        }
    }
    
    function setupRealtimeListener() {
        if (!currentUser) return;
        
        // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π
        unsubscribeAll();
        
        // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Firestore
        const unsubscribe = firebaseFirestore.collection('users')
            .doc(currentUser.uid)
            .onSnapshot(async (snapshot) => {
                if (snapshot.exists && !isSyncing) {
                    isSyncing = true;
                    
                    const cloudData = snapshot.data().data;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    const localData = loadFromLocal();
                    
                    // –ï—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±–æ–ª–µ–µ –Ω–æ–≤—ã–µ, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ–±–ª–∞—á–Ω—ã–µ
                    if (lastSyncTime && snapshot.data().updatedAt) {
                        const cloudTime = snapshot.data().updatedAt.toMillis();
                        if (cloudTime < lastSyncTime) {
                            isSyncing = false;
                            return;
                        }
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    db = cloudData;
                    saveToLocal();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º UI
                    updateUI();
                    
                    lastSyncTime = Date.now();
                    updateSyncStatus("–û–±–Ω–æ–≤–ª–µ–Ω–æ –∏–∑ –æ–±–ª–∞–∫–∞", "success");
                    
                    setTimeout(() => {
                        isSyncing = false;
                    }, 1000);
                }
            });
        
        unsubscribeFunctions.push(unsubscribe);
    }
    
    async function saveToCloud() {
        if (!currentUser || isSyncing) return;
        
        try {
            isSyncing = true;
            updateSyncStatus("–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –æ–±–ª–∞–∫–µ...", "syncing");
            
            await firebaseFirestore.collection('users').doc(currentUser.uid).update({
                data: db,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            lastSyncTime = Date.now();
            updateSyncStatus("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –æ–±–ª–∞–∫–µ", "success");
            
            setTimeout(() => {
                isSyncing = false;
            }, 1000);
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –æ–±–ª–∞–∫–µ:", error);
            updateSyncStatus("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è", "error");
            isSyncing = false;
        }
    }
    
    function unsubscribeAll() {
        unsubscribeFunctions.forEach(unsubscribe => {
            if (typeof unsubscribe === 'function') {
                unsubscribe();
            }
        });
        unsubscribeFunctions = [];
    }
    
    // ===== –£–¢–ò–õ–ò–¢–´ –î–õ–Ø –†–ê–ë–û–¢–´ –° –î–ê–ù–ù–´–ú–ò =====
    function getDefaultDb() {
        return {
            categories: [{id:1, name:'–°–∞–º–æ–∫–∞—Ç—ã', baseRate:10, tariffs:[
                {id:10, type:'fix', name:'30 –º–∏–Ω', dur:30, price:300},
                {id:11, type:'std', name:'–°—Ç–∞—Ä—Ç', start:50, min:10}
            ]}],
            fleet: [
                {id:1, name:'S-1', catId:1, status:'free', color:'#3b82f6'},
                {id:2, name:'S-2', catId:1, status:'free', color:'#ec4899'}
            ],
            clients: [],
            rentals: [],
            history: []
        };
    }
    
    function loadFromLocal() {
        const local = localStorage.getItem(`rm_cloud_${currentUser ? currentUser.uid : 'local'}`);
        return local ? JSON.parse(local) : null;
    }
    
    function saveToLocal() {
        const userId = currentUser ? currentUser.uid : 'local';
        localStorage.setItem(`rm_cloud_${userId}`, JSON.stringify(db));
    }
    
    function mergeData(cloudData, localData) {
        if (!localData) return cloudData;
        
        // –ü—Ä–æ—Å—Ç–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è —Å–ª–∏—è–Ω–∏—è - –±–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
        // –ú–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å –≤ –±—É–¥—É—â–µ–º
        return {
            categories: cloudData.categories || localData.categories || [],
            fleet: cloudData.fleet || localData.fleet || [],
            clients: cloudData.clients || localData.clients || [],
            rentals: cloudData.rentals || localData.rentals || [],
            history: cloudData.history || localData.history || []
        };
    }
    
    function updateSyncStatus(text, type = 'default') {
        const syncEl = document.getElementById('sync-status');
        const textEl = document.getElementById('sync-text');
        
        textEl.textContent = text;
        syncEl.className = 'sync-status';
        
        if (type !== 'default') {
            syncEl.classList.add(type);
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –µ—Å–ª–∏ –Ω–µ –æ—à–∏–±–∫–∞
        if (type === 'success') {
            setTimeout(() => {
                if (syncEl.classList.contains('success')) {
                    syncEl.classList.remove('success');
                }
            }, 3000);
        }
    }
    
    // ===== –û–°–ù–û–í–ù–û–ô –ö–û–î –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø (—Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏) =====
    let db = getDefaultDb();
    let tempStartData = null;
    let currentSwapRentalId = null;
    let wakeLock = null;
    
    // SOUND SYSTEM
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function unlockAudio() {
        if(audioCtx.state === 'suspended') {
            audioCtx.resume().then(() => console.log('Audio unlocked'));
        }
    }
    
    function save() {
        saveToLocal();
        saveToCloud(); // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –æ–±–ª–∞–∫–æ
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    function init() {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Firebase
        initFirebase();
        
        // –û—Å—Ç–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        if ("Notification" in window) Notification.requestPermission();
        
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('hist-start').value = today;
        document.getElementById('hist-end').value = today;
        document.getElementById('sur-start').value = today;
        
        // Auto-scroll –¥–ª—è –∏–Ω–ø—É—Ç–æ–≤
        const inputs = document.querySelectorAll('input, textarea');
        inputs.forEach(input => {
            input.addEventListener('focus', function() {
                setTimeout(() => {
                    this.scrollIntoView({behavior: "smooth", block: "center"});
                }, 300);
            });
        });
        
        document.addEventListener('click', unlockAudio, {once:true});
        document.addEventListener('touchstart', unlockAudio, {once:true});
        
        setInterval(tick, 1000);
        window.onclick = function(e) { 
            if(e.target.matches('.modal-overlay')) e.target.style.display='none'; 
            if(!e.target.matches('.device-filter-btn') && !e.target.closest('.device-dropdown')) 
                document.getElementById('dev-dd').style.display='none'; 
        }
    }
    
    // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –∑–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º –≤—ã–∑–æ–≤–æ–≤ save()
    // –í—Å–µ –≤—ã–∑–æ–≤—ã save() —Ç–µ–ø–µ—Ä—å —Å–æ—Ö—Ä–∞–Ω—è—é—Ç –∏ –ª–æ–∫–∞–ª—å–Ω–æ –∏ –≤ –æ–±–ª–∞–∫–æ
    
    // ===== –í–°–ï –û–°–¢–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô =====
    // playAlarm, renderNewRent, showTariffs, renderFleet, openVehicleNote, saveVehicleNote, 
    // deleteVehicleNote, renderClients, renderSettingsList, renderActiveRentals, getTimeLeft,
    // tick, renderSurcharge, renderHistory, toggleDevDropdown, filterDevDropdown, initDeviceFilter,
    // toggleAllDev, openSwapModal, renderSwapList, finalizeSwap, togglePause, openExtendModal,
    // applyExt, toggleHistoryStatus, toggleRepair, saveClient, delClient, openClientModal,
    // handleInput, fillClient, addVehicle, delCat, openCatModal, editCat, renderCatTariffs,
    // addTariffIO, delTariff, saveCat, closeModal, fullReset, clearHistory, updateUI,
    // switchView, openConfirm, sendNotify, askStartRental, confirmPaymentChoice, realStartRental,
    // finishRental, requestWakeLock, testAudio
    
    // ... (–≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ...
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    init();
</script>
</body>
</html>